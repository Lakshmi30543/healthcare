package com.sdp.health.service;

import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.List;
import java.util.Locale;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.sdp.health.dto.AppointmentBookingDTO;
import com.sdp.health.dto.DoctorRegisterRequest;
import com.sdp.health.model.Appointment;
import com.sdp.health.model.Doctor;
import com.sdp.health.repository.AppointmentRepository;
import com.sdp.health.repository.DoctorRepository;

@Service
public class DoctorServiceImpl implements DoctorService {
    @Autowired
    private DoctorRepository doctorRepository;

    @Override
    public String approveDoctor(Long doctorId) {
        Doctor doctor = doctorRepository.findById(doctorId)
            .orElseThrow(() -> new RuntimeException("Doctor not found with ID: " + doctorId));
        doctor.setApproved(true);
        doctorRepository.save(doctor);
        return "Doctor approved successfully";
    }

    @Override
    public Doctor findById(Long id) {
        return doctorRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Doctor not found with ID: " + id));
    }
    @Override
    public List<Doctor> getUnapprovedDoctors() {
        return doctorRepository.findByApprovedFalse(); // custom query
    }

    @Override
    public List<Doctor> getApprovedDoctors() {
        return doctorRepository.findByApprovedTrue(); // custom query
    }
    
    @Override
    public void rejectDoctor(Long doctorId) {
        Doctor doctor = doctorRepository.findById(doctorId).orElse(null);

        if (doctor != null) {
            doctorRepository.delete(doctor);
        } else {
            System.out.println("Doctor with ID " + doctorId + " not found.");
        }
    }
    @Override
    public long countApprovedDoctors() {
        return doctorRepository.countByApprovedTrue();
    }

    @Override
    public long countPendingDoctorApprovals() {
        return doctorRepository.countByApprovedFalse();
    }
    
    @Override
    public String updateDoctor(Long doctorId, DoctorRegisterRequest request) {
        Optional<Doctor> existingDoctor = doctorRepository.findById(doctorId);

        if (!existingDoctor.isPresent()) {
            return "Doctor not found!";
        }

        Doctor doctor = existingDoctor.get();

        // Updating the doctor fields with the new data, if present
        doctor.setFullName(request.getFullName() != null ? request.getFullName() : doctor.getFullName());
        doctor.setUsername(request.getUsername() != null ? request.getUsername() : doctor.getUsername());
        doctor.setPassword(request.getPassword() != null ? request.getPassword() : doctor.getPassword());
        doctor.setDob(request.getDob() != null ? request.getDob() : doctor.getDob());
        doctor.setEmail(request.getEmail() != null ? request.getEmail() : doctor.getEmail());
        doctor.setContact(request.getContact() != null ? request.getContact() : doctor.getContact());
        doctor.setGender(request.getGender() != null ? request.getGender() : doctor.getGender());
        doctor.setSpecialization(request.getSpecialization() != null ? request.getSpecialization() : doctor.getSpecialization());
        doctor.setQualification(request.getQualification() != null ? request.getQualification() : doctor.getQualification());
        doctor.setExperienceYears(request.getExperienceYears() != 0 ? request.getExperienceYears() : doctor.getExperienceYears());
        doctor.setMedicalLicenseNumber(request.getMedicalLicenseNumber() != null ? request.getMedicalLicenseNumber() : doctor.getMedicalLicenseNumber());
        
        doctor.setBio(request.getBio() != null ? request.getBio() : doctor.getBio());
        doctor.setPrize(request.getPrize() != null ? request.getPrize() : doctor.getPrize());
        doctor.setAddress(request.getAddress() != null ? request.getAddress() : doctor.getAddress());
        
        // Save the updated doctor
        doctorRepository.save(doctor);

        return "Doctor updated successfully!";
    }
    
    
    
    //Appointment Operations
    
    @Override
    public List<Appointment> getAppointmentsByDoctorId(Long doctorId) {
        return appointmentRepository.findByDoctorIdOrderByDateAsc(doctorId);
    }

    
    @Autowired
    private AppointmentRepository appointmentRepository;

    // Approve appointment
    @Override
    public Appointment approveAppointment(Long appointmentId) {
        Appointment appointment = appointmentRepository.findById(appointmentId)
                .orElseThrow(() -> new RuntimeException("Appointment not found"));
        appointment.setStatus("APPROVED");
        return appointmentRepository.save(appointment);
    }

    // Reject appointment
    @Override
    public Appointment rejectAppointment(Long appointmentId) {
        Appointment appointment = appointmentRepository.findById(appointmentId)
                .orElseThrow(() -> new RuntimeException("Appointment not found"));
        appointment.setStatus("REJECTED");
        return appointmentRepository.save(appointment);
    }

    // Reschedule appointment
    @Override
    public Appointment rescheduleAppointment(Long appointmentId, AppointmentBookingDTO dto) {
        Appointment appointment = appointmentRepository.findById(appointmentId)
                .orElseThrow(() -> new RuntimeException("Appointment not found"));

        LocalTime newTime = parseTime(dto.getTime());
        appointment.setAppointmentDate(LocalDate.parse(dto.getDate()));
        appointment.setAppointmentTime(newTime);
        return appointmentRepository.save(appointment);
    }

    private LocalTime parseTime(String timeString) {
        try {
            DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("h:mm a", Locale.US);
            return LocalTime.parse(timeString.trim(), timeFormatter);
        } catch (DateTimeParseException e) {
            throw new RuntimeException("Invalid time format", e);
        }
    }
}
